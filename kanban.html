<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Board - Task Management</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .kanban-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        
        .kanban-board {
            display: flex;
            gap: 20px;
            min-height: 600px;
        }
        
        .kanban-column {
            flex: 1;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .column-header {
            background: #007bff;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }
        
        .todo-header { background: #dc3545; }
        .in-progress-header { background: #ffc107; color: #000; }
        .done-header { background: #28a745; }
        
        .task-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: move;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .task-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .task-card.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }
        
        .task-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }
        
        .task-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .task-priority {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .priority-high { background: #ffebee; color: #c62828; }
        .priority-medium { background: #fff3e0; color: #ef6c00; }
        .priority-low { background: #e8f5e8; color: #2e7d32; }
        
        .add-task-btn {
            width: 100%;
            padding: 10px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .add-task-btn:hover {
            background: #5a6268;
        }
        
        .task-form {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 10px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group textarea {
            height: 60px;
            resize: vertical;
        }
        
        .form-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .task-actions {
            margin-top: 8px;
            display: flex;
            gap: 5px;
        }
        
        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .stats {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Kanban Board - Task Management</h1>
        <nav>
            <a href="index.html">Home</a> |
            <a href="about.html">About</a> |
            <a href="teams.html">Teams</a> |
            <a href="teams.html">Kanban Board</a>
        </nav>
    </header>

    <div class="kanban-container">
        <div class="stats">
            <h3>Project Statistics</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number" id="todo-count">0</div>
                    <div class="stat-label">To Do</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="in-progress-count">0</div>
                    <div class="stat-label">In Progress</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="done-count">0</div>
                    <div class="stat-label">Done</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="total-count">0</div>
                    <div class="stat-label">Total Tasks</div>
                </div>
            </div>
        </div>

        <div class="kanban-board">
            <div class="kanban-column" id="todo-column">
                <div class="column-header todo-header">To Do</div>
                <div id="todo-tasks"></div>
                <button class="add-task-btn" onclick="showAddTaskForm('todo')">+ Add Task</button>
            </div>
            
            <div class="kanban-column" id="in-progress-column">
                <div class="column-header in-progress-header">In Progress</div>
                <div id="in-progress-tasks"></div>
                <button class="add-task-btn" onclick="showAddTaskForm('in-progress')">+ Add Task</button>
            </div>
            
            <div class="kanban-column" id="done-column">
                <div class="column-header done-header">Done</div>
                <div id="done-tasks"></div>
                <button class="add-task-btn" onclick="showAddTaskForm('done')">+ Add Task</button>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 My Website - Kanban Board System</p>
    </footer>

    <script>
        let tasks = [];
        let taskIdCounter = 1;
        let currentTeamId = null;
        let currentUserEmail = '';
        let userRole = 'member';

        // Initialize the board
        function initBoard() {
            // Get team ID and user email from URL parameters or localStorage
            const urlParams = new URLSearchParams(window.location.search);
            currentTeamId = urlParams.get('team_id') || localStorage.getItem('currentTeamId');
            currentUserEmail = urlParams.get('user_email') || localStorage.getItem('userEmail');

            if (!currentTeamId || !currentUserEmail) {
                alert('Access denied. Please access the Kanban board through a team.');
                window.location.href = 'teams.html';
                return;
            }

            // Check team access
            checkTeamAccess();
        }

        // Check if user has access to the team
        function checkTeamAccess() {
            fetch(`/api/teams/${currentTeamId}/access?user_email=${encodeURIComponent(currentUserEmail)}`)
                .then(response => response.json())
                .then(result => {
                    if (result.success && result.hasAccess) {
                        userRole = result.role;
                        loadTasks();
                        setupDragAndDrop();
                    } else {
                        alert('Access denied. You are not a member of this team.');
                        window.location.href = 'teams.html';
                    }
                })
                .catch(error => {
                    console.error('Error checking team access:', error);
                    alert('Error checking team access. Please try again.');
                    window.location.href = 'teams.html';
                });
        }

        // Load tasks from database
        function loadTasks() {
            fetch(`/api/kanban/tasks?team_id=${currentTeamId}&user_email=${encodeURIComponent(currentUserEmail)}`)
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        tasks = result.tasks;
                        userRole = result.userRole;
                        renderTasks();
                        updateStats();
                    } else {
                        console.error('Failed to load tasks:', result.message);
                        alert('Failed to load tasks: ' + result.message);
                    }
                })
                .catch(error => {
                    console.error('Error loading tasks:', error);
                    alert('Error loading tasks. Please try again.');
                });
        }

        // Render all tasks
        function renderTasks() {
            const columns = {
                'todo': document.getElementById('todo-tasks'),
                'in-progress': document.getElementById('in-progress-tasks'),
                'done': document.getElementById('done-tasks')
            };

            // Clear all columns
            Object.values(columns).forEach(column => {
                column.innerHTML = '';
            });

            // Render tasks
            tasks.forEach(task => {
                const taskElement = createTaskElement(task);
                columns[task.status].appendChild(taskElement);
            });

            // Re-setup drag and drop after rendering
            setupDragAndDrop();
        }

        // Create task element
        function createTaskElement(task) {
            const taskDiv = document.createElement('div');
            taskDiv.className = 'task-card';
            taskDiv.draggable = true;
            taskDiv.dataset.taskId = task.id;

            taskDiv.innerHTML = `
                <div class="task-title">${task.title}</div>
                <div class="task-description">${task.description}</div>
                <div class="task-priority priority-${task.priority}">${task.priority.toUpperCase()}</div>
                <div class="task-actions">
                    <button class="btn btn-small btn-secondary" onclick="editTask(${task.id})">Edit</button>
                    <button class="btn btn-small btn-danger" onclick="deleteTask(${task.id})">Delete</button>
                </div>
            `;

            return taskDiv;
        }

        // Show add task form
        function showAddTaskForm(status) {
            const column = document.getElementById(status + '-column');
            const addButton = column.querySelector('.add-task-btn');
            
            const formDiv = document.createElement('div');
            formDiv.className = 'task-form';
            formDiv.innerHTML = `
                <div class="form-group">
                    <label>Title:</label>
                    <input type="text" id="task-title" placeholder="Enter task title">
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <textarea id="task-description" placeholder="Enter task description"></textarea>
                </div>
                <div class="form-group">
                    <label>Priority:</label>
                    <select id="task-priority">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="form-buttons">
                    <button class="btn btn-primary" onclick="addTask('${status}')">Add Task</button>
                    <button class="btn btn-secondary" onclick="cancelAddTask('${status}')">Cancel</button>
                </div>
            `;

            addButton.style.display = 'none';
            column.insertBefore(formDiv, addButton);
        }

        // Add new task
        function addTask(status) {
            const title = document.getElementById('task-title').value.trim();
            const description = document.getElementById('task-description').value.trim();
            const priority = document.getElementById('task-priority').value;

            if (!title) {
                alert('Please enter a task title');
                return;
            }

            const newTask = {
                title: title,
                description: description,
                priority: priority,
                status: status,
                team_id: currentTeamId,
                user_email: currentUserEmail
            };

            // Send to backend API
            fetch('/api/kanban/tasks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(newTask)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Add to local tasks array
                    tasks.push(result.task);
                    renderTasks();
                    updateStats();
                    cancelAddTask(status);
                } else {
                    alert('Failed to create task: ' + result.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to create task. Please try again.');
            });
        }

        // Cancel add task
        function cancelAddTask(status) {
            const column = document.getElementById(status + '-column');
            const form = column.querySelector('.task-form');
            const addButton = column.querySelector('.add-task-btn');
            
            if (form) {
                form.remove();
            }
            addButton.style.display = 'block';
        }

        // Edit task
        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            const newTitle = prompt('Edit title:', task.title);
            if (newTitle === null) return;

            const newDescription = prompt('Edit description:', task.description);
            if (newDescription === null) return;

            const newPriority = prompt('Edit priority (low/medium/high):', task.priority);
            if (newPriority === null) return;

            if (['low', 'medium', 'high'].includes(newPriority.toLowerCase())) {
                const updatedTask = {
                    title: newTitle.trim(),
                    description: newDescription.trim(),
                    priority: newPriority.toLowerCase(),
                    status: task.status,
                    team_id: currentTeamId,
                    user_email: currentUserEmail
                };

                // Send to backend API
                fetch(`/api/kanban/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updatedTask)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        // Update local task
                        task.title = updatedTask.title;
                        task.description = updatedTask.description;
                        task.priority = updatedTask.priority;
                        renderTasks();
                    } else {
                        alert('Failed to update task: ' + result.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to update task. Please try again.');
                });
            } else {
                alert('Priority must be low, medium, or high');
            }
        }

        // Delete task
        function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                // Send to backend API
                fetch(`/api/kanban/tasks/${taskId}?team_id=${currentTeamId}&user_email=${encodeURIComponent(currentUserEmail)}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        // Remove from local tasks array
                        tasks = tasks.filter(t => t.id !== taskId);
                        renderTasks();
                        updateStats();
                    } else {
                        alert('Failed to delete task: ' + result.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to delete task. Please try again.');
                });
            }
        }

        // Update task status when dragged
        function updateTaskStatus(taskId, newStatus) {
            const task = tasks.find(t => t.id === taskId);
            if (task && task.status !== newStatus) {
                const updatedTask = {
                    title: task.title,
                    description: task.description,
                    priority: task.priority,
                    status: newStatus,
                    team_id: currentTeamId,
                    user_email: currentUserEmail
                };

                // Send to backend API
                fetch(`/api/kanban/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updatedTask)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        task.status = newStatus;
                        renderTasks();
                        updateStats();
                    } else {
                        console.error('Failed to update task status:', result.message);
                    }
                })
                .catch(error => {
                    console.error('Error updating task status:', error);
                });
            }
        }

        // Update statistics
        function updateStats() {
            const todoCount = tasks.filter(t => t.status === 'todo').length;
            const inProgressCount = tasks.filter(t => t.status === 'in-progress').length;
            const doneCount = tasks.filter(t => t.status === 'done').length;
            const totalCount = tasks.length;

            document.getElementById('todo-count').textContent = todoCount;
            document.getElementById('in-progress-count').textContent = inProgressCount;
            document.getElementById('done-count').textContent = doneCount;
            document.getElementById('total-count').textContent = totalCount;
        }

        // Setup drag and drop
        function setupDragAndDrop() {
            // Remove existing event listeners to avoid duplicates
            const taskCards = document.querySelectorAll('.task-card');
            const dropZones = document.querySelectorAll('.kanban-column, #todo-tasks, #in-progress-tasks, #done-tasks');

            // Remove existing listeners
            taskCards.forEach(card => {
                card.removeEventListener('dragstart', handleDragStart);
                card.removeEventListener('dragend', handleDragEnd);
            });

            dropZones.forEach(zone => {
                zone.removeEventListener('dragover', handleDragOver);
                zone.removeEventListener('drop', handleDrop);
            });

            // Add new event listeners
            taskCards.forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            });

            dropZones.forEach(zone => {
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('drop', handleDrop);
            });
        }

        // Drag and drop handlers
        let draggedElement = null;

        function handleDragStart(e) {
            // Prevent dragging when interacting with action buttons
            if (e.target.closest && e.target.closest('.task-actions')) {
                e.preventDefault();
                return;
            }
            draggedElement = e.currentTarget;
            e.currentTarget.classList.add('dragging');
            if (e.dataTransfer) {
                e.dataTransfer.setData('text/plain', e.currentTarget.dataset.taskId || '');
                e.dataTransfer.effectAllowed = 'move';
            }
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedElement = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            if (e.dataTransfer) {
                e.dataTransfer.dropEffect = 'move';
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            
            if (!draggedElement) return;

            const taskId = parseInt(draggedElement.dataset.taskId);
            const currentZone = e.currentTarget;
            const columnElem = currentZone.classList.contains('kanban-column') 
                ? currentZone 
                : currentZone.closest('.kanban-column');
            if (!columnElem) return;
            const newStatus = columnElem.id.replace('-column', '');

            // Move element in DOM immediately for responsiveness
            const listContainer = columnElem.querySelector(`#${newStatus}-tasks`);
            if (listContainer && !listContainer.contains(draggedElement)) {
                listContainer.appendChild(draggedElement);
            }
            
            // Update task status
            updateTaskStatus(taskId, newStatus);
        }

        // Initialize the board when page loads
        document.addEventListener('DOMContentLoaded', initBoard);

        // Sample tasks will be loaded from database
    </script>

    <!-- Chat Widget -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="chat-widget.js"></script>
</body>
</html>
